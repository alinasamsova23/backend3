<!DOCTYPE html>
<html lang="russia">

<head>
    <title>Форма</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css"
        integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
</head>
<div class="row justify-content-md-center p-4">
<div class="col-12 col-md-6 jumbotron"
<body class="container"
</body>
<div class="row justify-content-md-center p-2">
    <form method="POST" class="col-12 col-md-6 align-self-center jumbotron p-4">
    <h1 class="text-center">Форма</h1>
    <div class="form-group">
      <input type="name" placeholder="Имя" name="name" class="form-control"><br>
      <input type="email" placeholder="Email" name="email" class="form-control"><br>
      <input type="number" placeholder="Год рождения" name="year" class="form-control"><br>
      </div>
      <h6>Пол</h6>
       <div class="form-group row col-6 justify-content-between">
      <div class="form-check">
      <label class="form-check-lable" for="gender">
        <input type="radio" value=0 name="gender" id="gender" class="form-check-input">
        М.
      </label>
      </div>
      <div class="form-check">
      <label class="form-check-lable" for="gender">
        <input type="radio" value=1 name="gender" id="gender" class="form-check-input">
        Ж.
      </label><br>
      </div>
      </div>
      <h6>Количество конечностей</h6>
      <div class="form-group row col-12 justify-content-between">
      	<div class="form-check">
      <input type="radio" value=1 name="limb" class="form-check-input">
        <label for="one" class="form-check-label">1</label>
        </div>
        <div class="form-check">
      <input type="radio" value=2 name="limb" class="form-check-input">
        <label for="two" class="form-check-label">2</label>
        </div>
        <div class="form-check">
      <input type="radio" value=3 name="limb" class="form-check-input">
        <label for="three" class="form-check-label">3</label>
        </div>
        <div class="form-check">
      <input type="radio" value=4 name="limb" class="form-check-input">
        <label for="four" class="form-check-label">4</label>
        </div>
        </div>
        <h6>Сверхспособности</h6>
        <div class="form-group">
      <select multiple name="superpowers[]" class="form-control">
        <option value=1>Вода</option>
        <option value=2>Земля</option>
        <option value=3>Огонь</option>
      </select>
      <br>
      </div>
      <h6>Биография</h6>
      <div class="form-group">
      <textarea name="bio" class="form-control"></textarea>
      <br>
      <div class="form-check">
      <label for="agreed" class="form-check-label">
        <input type="checkbox" name="agreed" id="agreed" class="form-check-input" required>
        с контрактом ознакомлен
      </label>
      </div>
      <br>
      <input type="submit" value="Отправить" class="form-control">
      </div>
    </form>
</div>
</body>
</html>

<?php
header('Content-Type: text/html; charset=UTF-8');
?>
<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Форма</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css"
        integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
</head>
<body class="container">

<?php
$ability_labels = [1 => 'Вода', 2=> 'Земля', 3=> 'Огонь'];
if ($_SERVER['REQUEST_METHOD'] == 'GET') {
  if (!empty($_GET['save'])) {
    print('<div class="row justify-content-md-center p-4">Спасибо, результаты сохранены.<br></div>');
  }
  include('form.php');
  exit();
}

$errors = FALSE;

?>
<div class="row justify-content-md-center p-4">
<div class="col-12 col-md-6 jumbotron">
<?php


if (empty($_POST['name'])) {
  print('Заполните имя.<br/>');
  $errors = TRUE;
}
else if (!preg_match('/^[а-яА-Я ]+$/u', $_POST['name'])) {
  print('Недопустимые символы в имени.<br/>');
  $errors = TRUE;
}


if(empty($_POST['email'])){
    print('Укажите email<br>');
    $errors = TRUE;
}else if(!preg_match('/^.*\@.*\..+$/u', $_POST['email'])){
    print('Неверно указан email<br>');
    $errors = TRUE;
}


if (empty($_POST['year'])) {
    print('Заполните год.<br/>');
    $errors = TRUE;
}
else {
    $year = $_POST['year'];
    if (!(is_numeric($year) && intval($year) >= 1900 && intval($year) <= 2020)) {
        print('Укажите корректный год.<br/>');
        $errors = TRUE;
    }
}


if(!isset($_POST['gender']))
{
    print('Выберите пол<br>');
    $errors = TRUE;
}
else if(intval($_POST['gender'])<0 || intval($_POST['gender'])>1)
{
    print('Неверно указан пол<br>');
    $errors = TRUE;
}


if(empty($_POST['limb']))
{
    print('Выберите количество конечностей<br>');
    $errors = TRUE;
}
else if($_POST['limb']<1 || $_POST['limb']>4)
{
    print('Неверное количество конечностей<br>');
    $errors = TRUE;
}


$ability_data = array_keys($ability_labels);
if (empty($_POST['powers'])) {
    print('Выберите способность.<br/>');
    $errors = TRUE;
}
else{
    $abilities = $_POST['superpowers'];
    foreach ($abilities as $ability) {
        if (!in_array($ability, $ability_data)) {
            print('Плохая способность!<br/>');
            $errors = TRUE;
        }
    }
}


if (empty($_POST['bio'])){
    print('Заполните биографию<br>');
    $errors = TRUE;
}


if(empty($_POST['agreed']))
{
    print('Вы не ознакомились с контрактом<br>');
    $errors = TRUE;
}else if($_POST['agreed']!=="on"){
    print('Вы не ознакомились с контрактом<br>');
    $errors = TRUE;
}
if ($errors) {
    print('<a href="index.php">Назад</a><br>');
}
?>

</div>
</div>

<?php
if ($errors) {
    exit();
}

$user = 'u20236';
$pass = '8398991';
$db = new PDO('mysql:host=localhost;dbname=u20236', $user, $pass, array(PDO::ATTR_PERSISTENT => true));
try {
$stmt = $db->prepare("INSERT INTO application (name, email, year, gender, limb, superpowers, bio) VALUES (?, ?, ?, ?, ?, ?, ?)");
$stmt->execute(array($_POST['name'], $_POST['email'], intval($_POST['year']), intval($_POST['gender']),intval($_POST['limb']), implode(',',$_POST['superpowers']), $_POST['bio'],));
}
catch(PDOException $e){
  print('Error : ' . $e->getMessage());
  exit();
}

header('Location: ?save=1');

?>
</body>
</html>



